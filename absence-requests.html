<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Absence Requests - Lecturer Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background: #f0f2f5; font-family: 'Poppins', sans-serif; padding: 20px; }
    .header { background: #384daa; color: white; padding: 40px 30px; border-radius: 12px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .logout-btn { background: #c03f41; border: none; padding: 8px 18px; border-radius: 8px; color: white; font-weight: bold; font-size: 14px; transition: background 0.3s; }
    .logout-btn:hover { background: #d9363e; }
    .summary { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
    .summary-card { flex: 1; background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; }
    .summary-card:hover { transform: translateY(-5px); background: #f1f3ff; }
    .summary-card h3 { margin: 0; font-size: 22px; color: #4361ee; }
    .summary-card p { margin: 5px 0 0; font-size: 16px; color: #555; }
    .table-responsive { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .table thead { background: #f8f9fa; }
    .table tbody tr:hover { background-color: #f1f3f5; }
    .status-pending { color: #fd7e14; font-weight: bold; }
    .status-approved { color: #28a745; font-weight: bold; }
    .status-rejected { color: #dc3545; font-weight: bold; }
    .action-btn { margin: 2px; padding: 5px 12px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; color: white; transition: 0.3s; }
    .approve-btn { background: #28a745; }
    .approve-btn:hover { background: #218838; }
    .reject-btn { background: #dc3545; }
    .reject-btn:hover { background: #c82333; }
    .view-btn { background: #0d6efd; border: none; padding: 5px 12px; border-radius: 6px; color: white; text-decoration: none; font-size: 13px; }
    .view-btn:hover { background: #0b5ed7; }
    #searchInput { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 100%; max-width: 400px; font-size: 14px; }
  </style>
</head>

<body>

<div class="header">
  <h2 id="welcomeMessage">Absence Requests Management</h2>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="summary">
  <div class="summary-card" onclick="filterStatus('All')">
    <h3 id="totalCount">0</h3>
    <p>Total Requests</p>
  </div>
  <div class="summary-card" onclick="filterStatus('Pending')">
    <h3 id="pendingCount">0</h3>
    <p>Pending</p>
  </div>
  <div class="summary-card" onclick="filterStatus('Approved')">
    <h3 id="approvedCount">0</h3>
    <p>Approved</p>
  </div>
  <div class="summary-card" onclick="filterStatus('Rejected')">
    <h3 id="rejectedCount">0</h3>
    <p>Rejected</p>
  </div>
</div>

<input type="text" id="searchInput" onkeyup="searchStudent()" placeholder="ðŸ”Ž Search by Student ID or Name...">

<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Student ID</th>
        <th>Student Name</th>
        <th>Reason</th>
        <th>Date</th>
        <th>Proof</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="requestTable">
      <!-- Data appears here -->
    </tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDufExYjU8Y2a1FEWwtbX6tNuL3tO8Mo2s",
  authDomain: "login-form-9b836.firebaseapp.com",
  databaseURL: "https://login-form-9b836-default-rtdb.firebaseio.com",
  projectId: "login-form-9b836",
  storageBucket: "login-form-9b836.appspot.com",
  messagingSenderId: "878421828817",
  appId: "1:878421828817:web:5941ad4c1605e9fc1551f0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const lecturerUsername = localStorage.getItem('username');
const lecturerName = localStorage.getItem('lecturerName');

if (!lecturerUsername) {
  alert("Session expired. Please login again.");
  window.location.href = "login.html";
}

if (lecturerName) {
  document.getElementById('welcomeMessage').textContent = `Welcome, ${lecturerName}`;
}

const requestTable = document.getElementById('requestTable');
const totalCount = document.getElementById('totalCount');
const pendingCount = document.getElementById('pendingCount');
const approvedCount = document.getElementById('approvedCount');
const rejectedCount = document.getElementById('rejectedCount');

let allRequests = [];

function loadRequests() {
  onValue(ref(db, `absence_requests/${lecturerUsername}`), snapshot => {
    allRequests = [];
    if (snapshot.exists()) {
      snapshot.forEach(childSnap => {
        const req = childSnap.val();
        req.key = childSnap.key;
        allRequests.push(req);
      });
    }
    renderTable(allRequests);
  });
}

function renderTable(data) {
  requestTable.innerHTML = "";
  let total = 0, pending = 0, approved = 0, rejected = 0;

  data.forEach(req => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${req.studentId}</td>
      <td>${req.studentName}</td>
      <td>${req.reason}</td>
      <td>${req.date}</td>
      <td>${req.proofLink ? `<a href="${req.proofLink}" target="_blank" class="view-btn">View Proof</a>` : 'No Proof'}</td>
      <td class="${req.status === 'Pending' ? 'status-pending' : req.status === 'Approved' ? 'status-approved' : 'status-rejected'}">${req.status}</td>
      <td>
        ${req.status === "Pending" ? `
          <button class="action-btn approve-btn" onclick="updateStatus('${req.key}', 'Approved', '${req.classId}', '${req.studentId}', '${req.date}')">Approve</button>
          <button class="action-btn reject-btn" onclick="updateStatus('${req.key}', 'Rejected')">Reject</button>
        ` : ''}
      </td>
    `;
    requestTable.appendChild(tr);

    total++;
    if (req.status === "Pending") pending++;
    if (req.status === "Approved") approved++;
    if (req.status === "Rejected") rejected++;
  });

  totalCount.textContent = total;
  pendingCount.textContent = pending;
  approvedCount.textContent = approved;
  rejectedCount.textContent = rejected;
}

window.filterStatus = (status) => {
  if (status === 'All') {
    renderTable(allRequests);
  } else {
    const filtered = allRequests.filter(req => req.status === status);
    renderTable(filtered);
  }
};

window.searchStudent = () => {
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allRequests.filter(req =>
    req.studentId.toLowerCase().includes(keyword) ||
    req.studentName.toLowerCase().includes(keyword)
  );
  renderTable(filtered);
};

window.updateStatus = async (key, status, classId = null, studentId = null, date = null) => {
  const updateRef = ref(db, `absence_requests/${lecturerUsername}/${key}`);
  await update(updateRef, { status });

  if (status === "Approved" && classId && studentId && date) {
    const attendanceRef = ref(db, `attendance/${classId}/${studentId}/${date}`);
    await update(attendanceRef, { status: "Absent with Permission" });
  }

  Swal.fire({ icon: 'success', title: `âœ… ${status} Successfully!`, timer: 1500, showConfirmButton: false });
  loadRequests();
};

window.logout = function() {
  localStorage.clear();
  window.location.href = "login.html";
};

loadRequests();
</script>

</body>
</html>
