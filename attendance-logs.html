<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(to right, #f8f9fa, #e8f0ff);
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 40px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .controls {
      text-align: center;
      margin-bottom: 30px;
    }
    .controls button {
      padding: 12px 30px;
      margin: 10px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      background-color: #2c3e50;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    }
    .controls button:hover { background-color: #1a252f; }
    .controls input {
      padding: 12px;
      width: 300px;
      margin: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #bbb;
    }
    .date-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin: 0 auto 30px auto;
      max-width: 900px;
    }
    .date-item {
      background-color: #fff;
      padding: 18px;
      text-align: center;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(0,0,0,0.04);
      cursor: pointer;
      transition: 0.3s;
    }
    .date-item:hover {
      background-color: #e9f5ff;
      border-color: #2c3e50;
    }
    table {
      width: 95%;
      max-width: 1400px;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 14px 20px;
      text-align: left;
      font-size: 15px;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #2c3e50;
      color: #fff;
      text-transform: uppercase;
    }
    tr:hover { background-color: #f0f0f0; }
    .message {
      text-align: center;
      font-size: 16px;
      color: #cc0000;
      margin-top: 20px;
      font-weight: bold;
    }
    #classInfoContainer {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
    }
      #spinner {
      display: none;
      margin: 20px auto;
      width: 60px;
      height: 60px;
      border: 6px solid #ccc;
      border-top: 6px solid #2c3e50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

<h2>DAILY ATTENDANCE RECORD</h2>

<div class="controls">
  <div id="classButtons">Loading classes...</div>
  <input type="text" id="searchInput" placeholder="Search by Student ID..." onkeyup="filterTable()" />
</div>

<div id="spinner"></div>
<div id="dateListContainer"></div>
<div id="classInfoContainer"></div>
<div id="attendanceTableContainer"></div>
<div class="message" id="message"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDufExYjU8Y2a1FEWwtbX6tNuL3tO8Mo2s",
  authDomain: "login-form-9b836.firebaseapp.com",
  databaseURL: "https://login-form-9b836-default-rtdb.firebaseio.com",
  projectId: "login-form-9b836",
  storageBucket: "login-form-9b836.appspot.com",
  messagingSenderId: "878421828817",
  appId: "1:878421828817:web:5941ad4c1605e9fc1551f0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

auth.onAuthStateChanged(user => {
  if (user) {
    const username = localStorage.getItem("username");
    if (!username) {
      document.getElementById("classButtons").innerHTML = "❌ Username not found. Please login again.";
      return;
    }
    loadClassButtons(username);
  } else {
    document.getElementById("classButtons").innerHTML = "❌ Not logged in. Please login.";
  }
});

function loadClassButtons(currentUsername) {
  const container = document.getElementById("classButtons");
  document.getElementById("spinner").style.display = "block";

  db.ref("class_schedules").once("value").then(snapshot => {
    container.innerHTML = "";
    document.getElementById("spinner").style.display = "none";

    snapshot.forEach(classSnap => {
      const classId = classSnap.key;
      const classObj = classSnap.child("class").val();

      for (const classKey in classObj) {
        const data = classObj[classKey];
        if (data.lecturer_username !== currentUsername) continue;

        const className = data.class_name || classKey;
        const button = document.createElement("button");
        button.textContent = `${classId} (${className})`;
        button.onclick = () => loadClass(classId, classKey, className);
        container.appendChild(button);
      }
    });

    if (!container.hasChildNodes()) {
      container.innerHTML = "❗ No classes assigned to you.";
    }
  });
}

function loadClass(classId, classKey, className) {
  // Clear existing content immediately when switching class
  document.getElementById("dateListContainer").innerHTML = "";
  document.getElementById("attendanceTableContainer").innerHTML = "";
  document.getElementById("classInfoContainer").innerHTML = "";
  document.getElementById("message").textContent = "";

  document.getElementById("spinner").style.display = "block";
  db.ref(`attendance/${classId}/class/${classKey}`).once("value", snapshot => {
    document.getElementById("spinner").style.display = "none";

    if (!snapshot.exists()) {
      document.getElementById("message").textContent = "No attendance data.";
      return;
    }

    const dates = new Set();
    snapshot.forEach(studentSnap => {
      studentSnap.forEach(dateSnap => {
        const timestamp = dateSnap.val().timestamp;
        if (timestamp) {
          const dateOnly = timestamp.split(" ")[0];
          dates.add(dateOnly);
        }
      });
    });

    const sortedDates = Array.from(dates).sort();
    const dateListHtml = sortedDates.map(d => `
      <div class="date-item" onclick="loadAttendanceForDate('${classId}', '${classKey}', '${className}', '${d}')">${d}</div>
    `).join("");

    document.getElementById("dateListContainer").innerHTML = `<div class="date-list">${dateListHtml}</div>`;
  });
}


function loadAttendanceForDate(classId, classKey, className, date) {
  document.getElementById("spinner").style.display = "block";
  db.ref(`attendance/${classId}/class/${classKey}`).once("value", snapshot => {
    document.getElementById("spinner").style.display = "none";
    if (!snapshot.exists()) {
      document.getElementById("message").textContent = "No attendance data found.";
      return;
    }

    let records = [], presentCount = 0, absentCount = 0;

    snapshot.forEach(studentSnap => {
      const studentID = studentSnap.key;

      studentSnap.forEach(recordSnap => {
        const r = recordSnap.val();
        const timestamp = r.timestamp;
        if (timestamp && timestamp.startsWith(date)) {
          records.push({ studentID, name: r.name, status: r.status, timestamp });

          const statusLower = r.status.toLowerCase();
          if (statusLower === 'on time' || statusLower === 'late') presentCount++;
          else if (statusLower === 'absent') absentCount++;
        }
      });
    });



    const day = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });

    db.ref(`class_schedules/${classId}/class/${classKey}`).once("value", metaSnap => {
      const meta = metaSnap.val();
      const hour = meta?.class_days?.[day]?.hour ?? "--";
      const minute = meta?.class_days?.[day]?.minute ?? "--";
      const classTime = (hour !== "--") ? `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}` : "Not Scheduled";

      document.getElementById("classInfoContainer").innerHTML = `CLASS: ${className} &nbsp; | &nbsp; DAY: ${day} &nbsp; | &nbsp; TIME: ${classTime}`;

      let tableHtml = `
        <table id="attendanceTable">
          <thead>
            <tr>
              <th>Bil</th>
              <th>Student ID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
      `;

      records.sort((a, b) => a.name.localeCompare(b.name));
      records.forEach((rec, idx) => {
        const fontColor = rec.status.toLowerCase() === 'on time' ? 'green' :
                          rec.status.toLowerCase() === 'late' ? 'orange' : 'red';
        tableHtml += `
          <tr>
            <td>${idx + 1}</td>
            <td>${rec.studentID}</td>
            <td>${rec.name}</td>
            <td style="color:${fontColor}; font-weight:bold;">${rec.status}</td>
            <td>${rec.timestamp}</td>
          </tr>
        `;
      });

      tableHtml += `
          </tbody>
        </table>
        <div style="max-width:1400px;margin:20px auto;text-align:right;padding:10px;">
          <span style="color:green;font-weight:bold;">Present: ${presentCount}</span> | 
          <span style="color:red;font-weight:bold;">Absent: ${absentCount}</span>
        </div>
        <div style="max-width:400px;margin:30px auto;">
          <canvas id="attendanceChart"></canvas>
        </div>
      `;

      document.getElementById("attendanceTableContainer").innerHTML = tableHtml;

      setTimeout(() => {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ["Present", "Absent"],
            datasets: [{ data: [presentCount, absentCount], backgroundColor: ["green", "red"] }]
          },
          options: {
            plugins: {
              legend: { position: "bottom" },
              datalabels: {
                color: '#fff',
                font: { weight: 'bold', size: 14 },
                formatter: (value, ctx) => {
                  const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  if (total === 0) return '';
                  const percentage = (value / total * 100).toFixed(1);
                  return value === 0 ? '' : `${percentage}%`;
                }
              }
            },
            animation: { animateRotate: true, animateScale: true }
          },
          plugins: [ChartDataLabels]
        });
      }, 300);
    });
  });
}

function filterTable() {
  const input = document.getElementById("searchInput").value.toUpperCase();
  const rows = document.querySelectorAll("#attendanceTable tbody tr");
  rows.forEach(row => {
    const idCell = row.children[1].textContent.toUpperCase();
    row.style.display = idCell.includes(input) ? "" : "none";
  });
}
</script>

</body>
</html>
