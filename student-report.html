<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Monthly Attendance Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 40px 20px;
    }

    h2 {
      text-align: center;
      color: #2c3e50;
      font-size: 40px;
      margin-bottom: 10px;
    }

    #studentImage {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 0 auto 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    #studentName {
      text-align: center;
      font-weight: bold;
      font-size: 26px;
      color: #2c3e50;
      margin-bottom: 40px;
    }

    .report-wrapper {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 60px;
      align-items: center;
    }

    .chart-box, .stats-box {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 30px;
      width: 600px;
      height: 450px;
      box-sizing: border-box;
    }

    .chart-box canvas {
      max-height: 320px;
      margin: auto;
    }

    .stats-box .stat {
      margin: 12px 0;
      font-size: 18px;
      font-weight: bold;
      color: white;
      padding: 14px;
      border-radius: 8px;
      text-align: center;
    }

    .on-time { background-color: #4caf50; }
    .late { background-color: #ff9800; }
    .absent { background-color: #f44336; }
    .total { background-color: #6c757d; }

    .percentage {
      margin-top: 20px;
      background: #2c3e50;
      color: #fff;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .warning {
      color: #c0392b;
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>
  <h2>STUDENT MONTHLY ATTENDANCE REPORT</h2>
  <img id="studentImage" src="images/default-avatar.png" alt="Student Profile" />
  <div id="studentName">Loading...</div>

  <div class="report-wrapper" id="reportContent">
    <div class="chart-box">
      <canvas id="attendanceChart" width="300" height="300"></canvas>
    </div>
    <div class="stats-box">
      <div class="stat on-time" id="onTime">On Time: --</div>
      <div class="stat late" id="late">Late: --</div>
      <div class="stat absent" id="absent">Absent: --</div>
      <div class="stat total" id="total">Total Days: --</div>
      <div class="percentage" id="percentage">Attendance %: --</div>
      <div class="warning" id="warningBox" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDufExYjU8Y2a1FEWwtbX6tNuL3tO8Mo2s",
      authDomain: "login-form-9b836.firebaseapp.com",
      databaseURL: "https://login-form-9b836-default-rtdb.firebaseio.com",
      projectId: "login-form-9b836",
      storageBucket: "login-form-9b836.appspot.com",
      messagingSenderId: "878421828817",
      appId: "1:878421828817:web:5941ad4c1605e9fc1551f0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');
    const fullClassPath = urlParams.get('classId'); // like "CDCS2306A/class/class1"
    const [classId, , classKey] = fullClassPath.split('/');

    async function loadStudentReport() {
      const attendanceRef = ref(db, `attendance/${classId}/class/${classKey}/${studentId}`);
      const snapshot = await get(attendanceRef);

      if (!snapshot.exists()) {
        document.getElementById("studentName").textContent = "Student data not found.";
        return;
      }

      const data = snapshot.val();
      const keys = Object.keys(data).filter(k => data[k].name && data[k].status);
      const studentName = keys.length > 0 ? data[keys[0]].name : "Unknown";

      let onTime = 0, late = 0, absent = 0;
      keys.forEach(key => {
        const status = data[key].status;
        if (status === "On Time") onTime++;
        else if (status === "Late") late++;
        else if (status === "Absent") absent++;
      });

      const total = onTime + late + absent;
      const percent = total ? (((onTime + late) / total) * 100).toFixed(1) : "0";

      document.getElementById("studentName").textContent = `${studentName.toUpperCase()} ( ${studentId} )`;
      document.getElementById("onTime").textContent = `ON TIME : ${onTime}`;
      document.getElementById("late").textContent = `LATE : ${late}`;
      document.getElementById("absent").textContent = `ABSENT : ${absent}`;
      document.getElementById("total").textContent = `TOTAL DAYS : ${total}`;
      document.getElementById("percentage").textContent = `ATTENDANCE PERCENTAGE: ${percent}%`;

      if (percent < 75) {
        document.getElementById("warningBox").style.display = "block";
        document.getElementById("warningBox").textContent = "⚠️ Low Attendance Warning!";
      }

      // Set image manually using static URL (fallback already set in HTML)
      const img = document.getElementById("studentImage");
      const imageUrl = `https://firebasestorage.googleapis.com/v0/b/login-form-9b836.firebasestorage.app/o/profile_pics%2F${studentId}.jpg?alt=media&token=8442cec8-2799-481d-ba5e-deaea4d30708`;
      const testImage = new Image();
      testImage.onload = () => img.src = imageUrl;  // Only use if load is successful
      testImage.onerror = () => console.warn("Profile image not found, using fallback.");
      testImage.src = imageUrl;

      drawChart(onTime, late, absent);
    }

    function drawChart(onTime, late, absent) {
  const ctx = document.getElementById("attendanceChart").getContext("2d");

  // Check if chart exists and is a valid Chart.js instance
  if (window.attendanceChart instanceof Chart) {
    window.attendanceChart.destroy();
  }

  // Create new chart and store it in the window
  window.attendanceChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["On Time", "Late", "Absent"],
      datasets: [{
        data: [onTime, late, absent],
        backgroundColor: ["#4caf50", "#ff9800", "#f44336"]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
}

    loadStudentReport();
  </script>
</body>
</html>
